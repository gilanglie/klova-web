<?php
 
/**
 * Plugin Name: EMS Shipping
 * Plugin URI: http://code.tutsplus.com/tutorials/create-a-custom-shipping-method-for-woocommerce--cms-26098
 * Description: Custom Shipping Method for WooCommerce
 * Version: 1.0.0
 * Author: Igor BeniÄ‡
 * Author URI: http://www.ibenic.com
 * License: GPL-3.0+
 * License URI: http://www.gnu.org/licenses/gpl-3.0.html
 * Domain Path: /lang
 * Text Domain: tutsplus
 */
 
if ( ! defined( 'WPINC' ) ) {
 
    die;
 
}
 
/*
 * Check if WooCommerce is active
 */
if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) ) {
 
    function tutsplus_shipping_method() {
        if ( ! class_exists( 'TutsPlus_Shipping_Method' ) ) {
            class TutsPlus_Shipping_Method extends WC_Shipping_Method {
                /**
                 * Constructor for your shipping class
                 *
                 * @access public
                 * @return void
                 */
                public function __construct() {
                    $this->id                 = 'tutsplus'; 
                    $this->method_title       = __( 'EMS Shipping', 'tutsplus' );  
                    $this->method_description = __( 'Custom Shipping Method for EMS', 'tutsplus' ); 
 
                    // Availability & Countries
                    $this->availability = 'including';
                    $this->countries = array(
                        'DZ',
                        'US',
                        'AU',
                        'AT',
                        'AZ',
                        'BH',
                        'BD',
                        'NL',
                        'BE',
                        'BR',
                        'BN',
                        'KH',
                        'DK',
                        'FI',
                        'HK',
                        'IN',
                        'GB',
                        'IQ',
                        'IE',
                        'IT',
                        'JP',
                        'DE',
                        'KR',
                        'KW',
                        'MO',
                        'MY',
                        'MV',
                        'EG',
                        'NP',
                        'NC',
                        'NZ',
                        'NG',
                        'NO',
                        'PK',
                        'PG',
                        'FR',
                        'PH',
                        'PL',
                        'PT',
                        'QA',
                        'CN',
                        'RU',
                        'SA',
                        'SG',
                        'SD',
                        'SE',
                        'CH',
                        'TW',
                        'TH',
                        'AE',
                        'VN',
                        'CR',
                        'CL',
                        'CO',
                        'DM',
                        'DO',
                        'EC',
                        'SV',
                        'HN',
                        'HT',
                        'MX',
                        'ES',
                        'AL',
                        'AR',
                        'BG',
                        'GR',
                        'IR',
                        'JO',
                        'LO',
                        'MA',
                        'MU',
                        'MM',
                        'OM',
                        'PA',
                        'SN',
                        'SR',
                        'SY',
                        'TN',
                        'TR',
                        'VE',
                        'YE',
                        'ZM',
			/**'ID',*/
            );
 
                    $this->init();
 
                    $this->enabled = isset( $this->settings['enabled'] ) ? $this->settings['enabled'] : 'yes';
                    $this->title = isset( $this->settings['title'] ) ? $this->settings['title'] : __( 'EMS Shipping', 'tutsplus' );
                }
 
                /**
                 * Init your settings
                 * 
                 * @access public
                 * @return void
                 */
                function init() {
                    // Load the settings API
                    $this->init_form_fields(); 
                    $this->init_settings(); 
 
                    // Save settings in admin if you have any defined
                    add_action( 'woocommerce_update_options_shipping_' . $this->id, array( $this, 'process_admin_options' ) );
                }
 
                /**
                 * Define settings field for this shipping
                 * @return void 
                 */
                function init_form_fields() { 
 
                    $this->form_fields = array(
 
                     'enabled' => array(
                          'title' => __( 'Enable', 'tutsplus' ),
                          'type' => 'checkbox',
                          'description' => __( 'Enable this shipping.', 'tutsplus' ),
                          'default' => 'yes'
                          ),
 
                     'title' => array(
                        'title' => __( 'Title', 'tutsplus' ),
                          'type' => 'text',
                          'description' => __( 'Title to be display on site', 'tutsplus' ),
                          'default' => __( 'EMS Shipping', 'tutsplus' )
                          ),
 
                     'weight' => array(
                        'title' => __( 'Weight (kg)', 'tutsplus' ),
                          'type' => 'number',
                          'description' => __( 'Maximum allowed weight', 'tutsplus' ),
                          'default' => 5
                          ),
                    'insurance' => array(
                    'title' => __( 'Tax', 'tutsplus' ),
                        'type' => 'number',
                        'description' => __( 'Tax', 'tutsplus' ),
                        'default' => 10
                        ),
                     );
                     
 
                }
 
                /**
                 * This function is used to calculate the shipping cost. Within this function we can check for weights, dimensions and other parameters.
                 *
                 * @access public
                 * @param mixed $package
                 * @return void
                 */
                public function calculate_shipping( $package = array() ) {
                    
                    $weight = 0;
                    $cost = 0;
                    $country = $package["destination"]["country"];
 
                    foreach ( $package['contents'] as $item_id => $values ) 
                    { 
                        $_product = $values['data']; 
                        $weight = $weight + $_product->get_weight() * $values['quantity']; 
                    }
                    $weight = wc_get_weight( $weight, 'gr' );  
 
                    $countryZones =   array (
                        'DZ' => 0,
                        'US' => 1,
                        'AU' => 2,
                        'AT' => 3,
                        'AZ' => 4,
                        'BH' => 5,
                        'BD' => 6,
                        'NL' => 7,
                        'BE' => 8,
                        'BR' => 9,
                        'BN' => 10,
                        'KH' => 11,
                        'DK' => 12,
                        'FI' => 13,
                        'HK' => 14,
                        'IN' => 15,
                        'GB' => 16,
                        'IQ' => 17,
                        'IE' => 18,
                        'IT' => 19,
                        'JP' => 20,
                        'DE' => 21,
                        'KR' => 23,
                        'KW' => 24,
                        'MO' => 25,
                        'MY' => 26,
                        'MV' => 27,
                        'EG' => 28,
                        'NP' => 29,
                        'NC' => 30,
                        'NZ' => 31,
                        'NG' => 32,
                        'NO' => 33,
                        'PK' => 34,
                        'PG' => 35,
                        'FR' => 36,
                        'PH' => 37,
                        'PL' => 38,
                        'PT' => 39,
                        'QA' => 40,
                        'CN' => 41,
                        'RU' => 42,
                        'SA' => 43,
                        'SG' => 44,
                        'SD' => 45,
                        'SE' => 46,
                        'CH' => 47,
                        'TW' => 48,
                        'TH' => 49,
                        'AE' => 50,
                        'VN' => 51,
                        'CR' => 52,
                        'CL' => 53,
                        'CO' => 54,
                        'DM' => 55,
                        'DO' => 56,
                        'EC' => 57,
                        'SV' => 58,
                        'HN' => 59,
                        'HT' => 60,
                        'MX' => 61,
                        'ES' => 62,
                        'AL' => 63,
                        'AR' => 64,
                        'BG' => 65,
                        'GR' => 66,
                        'IR' => 67,
                        'JO' => 68,
                        'LO' => 69,
                        'MA' => 70,
                        'MU' => 71,
                        'MM' => 72,
                        'OM' => 73,
                        'PA' => 74,
                        'SN' => 75,
                        'SR' => 76,
                        'SY' => 77,
                        'TN' => 78,
                        'TR' => 79,
                        'VE' => 80,
                        'YE' => 81,
                        'ZM' => 82,
			/**'ID' => 83,*/
                    );
 
                        
                    if( $weight <= 0.25 ) {

                        $zonePrices = array (
                            0 => 26.6,
                            1 => 15.9,
                            2 => 17.5,
                            3 => 17.2,
                            4 => 19.3,
                            5 => 19.5,
                            6 => 10.2,
                            7 => 31.4,
                            8 => 22.3,
                            9 => 21.4,
                            10 => 13.2,
                            11 => 13.7,
                            12 => 27.6,
                            13 => 26.1,
                            14 => 17.9,
                            15 => 14.2,
                            16 => 25.3,
                            17 => 11.9,
                            18 => 28.7,
                            19 => 27.3,
                            20 => 14.4,
                            21 => 26.5,
                            22 => 24.9,
                            23 => 14.3,
                            24 => 19.1,
                            25 => 13.7,
                            26 => 13.1,
                            27 => 14,
                            28 => 21.6,
                            29 => 14,
                            30 => 23,
                            31 => 11.8,
                            32 => 23.8,
                            33 => 29,
                            34 => 14.3,
                            35 => 16.1,
                            36 => 24.4,
                            37 => 13.6,
                            38 => 21.9,
                            39 => 20.5,
                            40 => 21,
                            41 => 14.3,
                            42 => 19.6,
                            43 => 15,
                            44 => 10.9,
                            45 => 15.4,
                            46 => 28.3,
                            47 => 26.4,
                            48 => 13.9,
                            49 => 11.3,
                            50 => 18.8,
                            51 => 13.6,
                            52 => 33.2,
                            53 => 33.2,
                            54 => 33.2,
                            55 => 33.2,
                            56 => 33.2,
                            57 => 33.2,
                            58 => 33.2,
                            59 => 33.2,
                            60 => 33.2,
                            61 => 33.9,
                            62 => 30.8,
                            63 => 30.8,
                            64 => 33.2,
                            65 => 30.8,
                            66 => 30.8,
                            67 => 30.8,
                            68 => 30.8,
                            69 => 25,
                            70 => 33.2,
                            71 => 30.8,
                            72 => 25,
                            73 => 30.8,
                            74 => 33.2,
                            75 => 33.2,
                            76 => 33.2,
                            77 => 30.8,
                            78 => 33.2,
                            79 => 33.2,
                            80 => 33.2,
                            81 => 30.8,
                            82 => 33.2,
			    /**83 => 0,*/
                        );
    
    
                    } elseif( $weight <= 0.5 ) {
    
                        $zonePrices = array (
                            0 => 31.2,
                            1 => 21.8,
                            2 => 20.3,
                            3 => 21.4,
                            4 => 22.8,
                            5 => 22.7,
                            6 => 12.6,
                            7 => 35.9,
                            8 => 26.8,
                            9 => 27.1,
                            10 => 14.9,
                            11 => 16,
                            12 => 31.9,
                            13 => 30.2,
                            14 => 20,
                            15 => 16.9,
                            16 => 29.9,
                            17 => 15.4,
                            18 => 33.4,
                            19 => 31.7,
                            20 => 17.3,
                            21 => 30.9,
                            22 => 29.9,
                            23 => 17,
                            24 => 22.4,
                            25 => 16,
                            26 => 14.7,
                            27 => 16.5,
                            28 => 25.4,
                            29 => 16.5,
                            30 => 26.2,
                            31 => 15.2,
                            32 => 28.7,
                            33 => 33.4,
                            34 => 17.1,
                            35 => 18.7,
                            36 => 28.9,
                            37 => 15.6,
                            38 => 26.1,
                            39 => 25.4,
                            40 => 24.2,
                            41 => 17,
                            42 => 23.5,
                            43 => 18.6,
                            44 => 12.4,
                            45 => 19.2,
                            46 => 32.5,
                            47 => 30.8,
                            48 => 16.2,
                            49 => 13.3,
                            50 => 22,
                            51 => 15.8,
                            52 => 35.9,
                            53 => 35.9,
                            54 => 35.9,
                            55 => 35.9,
                            56 => 35.9,
                            57 => 35.9,
                            58 => 35.9,
                            59 => 35.9,
                            60 => 35.9,
                            61 => 36.6,
                            62 => 33.2,
                            63 => 33.2,
                            64 => 35.9,
                            65 => 33.2,
                            66 => 33.2,
                            67 => 33.2,
                            68 => 33.2,
                            69 => 27,
                            70 => 35.9,
                            71 => 33.2,
                            72 => 27,
                            73 => 33.2,
                            74 => 35.9,
                            75 => 35.9,
                            76 => 35.9,
                            77 => 33.2,
                            78 => 35.9,
                            79 => 35.9,
                            80 => 35.9,
                            81 => 33.2,
                            82 => 35.9,
                        );
        
                    } elseif( $weight <= 1 ) {
    
                        $zonePrices = array (
                            0 => 39.9,
                            1 => 33,
                            2 => 25.5,
                            3 => 29.4,
                            4 => 29.6,
                            5 => 28.8,
                            6 => 16.8,
                            7 => 44.5,
                            8 => 35.3,
                            9 => 38.2,
                            10 => 17.9,
                            11 => 20,
                            12 => 40.1,
                            13 => 38.1,
                            14 => 24,
                            15 => 21.8,
                            16 => 38.6,
                            17 => 22,
                            18 => 42.3,
                            19 => 39.9,
                            20 => 22.8,
                            21 => 39.2,
                            22 => 39.6,
                            23 => 22.1,
                            24 => 28.7,
                            25 => 20,
                            26 => 17.5,
                            27 => 21.1,
                            28 => 32.5,
                            29 => 21.1,
                            30 => 32,
                            31 => 21.6,
                            32 => 38.1,
                            33 => 41.7,
                            34 => 22.3,
                            35 => 23.3,
                            36 => 37.5,
                            37 => 19.3,
                            38 => 34,
                            39 => 34.6,
                            40 => 30.2,
                            41 => 22.1,
                            42 => 30.8,
                            43 => 25.2,
                            44 => 15,
                            45 => 26.5,
                            46 => 40.6,
                            47 => 39.2,
                            48 => 20.4,
                            49 => 16.7,
                            50 => 27.8,
                            51 => 19.6,
                            52 => 53,
                            53 => 53,
                            54 => 53,
                            55 => 53,
                            56 => 53,
                            57 => 53,
                            58 => 53,
                            59 => 53,
                            60 => 53,
                            61 => 43.3,
                            62 => 42.4,
                            63 => 42.4,
                            64 => 53,
                            65 => 42.4,
                            66 => 42.4,
                            67 => 42.4,
                            68 => 42.4,
                            69 => 32,
                            70 => 53,
                            71 => 42.4,
                            72 => 32,
                            73 => 42.4,
                            74 => 53,
                            75 => 53,
                            76 => 53,
                            77 => 42.4,
                            78 => 53,
                            79 => 53,
                            80 => 53,
                            81 => 42.4,
                            82 => 53,
                        );
        
                    } elseif( $weight <= 1.5 ) {
    
                        $zonePrices =   array (
                            0 => 50.5,
                            1 => 46.1,
                            2 => 35.1,
                            3 => 39.3,
                            4 => 38.2,
                            5 => 36.7,
                            6 => 22.9,
                            7 => 54.9,
                            8 => 45.7,
                            9 => 51,
                            10 => 22.8,
                            11 => 25.9,
                            12 => 50.2,
                            13 => 47.7,
                            14 => 29.7,
                            15 => 28.5,
                            16 => 49.1,
                            17 => 30.5,
                            18 => 53.1,
                            19 => 49.9,
                            20 => 30,
                            21 => 49.5,
                            22 => 51.1,
                            23 => 29,
                            24 => 36.8,
                            25 => 25.9,
                            26 => 22.1,
                            27 => 27.5,
                            28 => 41.6,
                            29 => 27.5,
                            30 => 39.7,
                            31 => 29.8,
                            32 => 49.4,
                            33 => 51.8,
                            34 => 29.4,
                            35 => 29.8,
                            36 => 48,
                            37 => 24.9,
                            38 => 43.7,
                            39 => 45.8,
                            40 => 38.1,
                            41 => 29,
                            42 => 40,
                            43 => 33.6,
                            44 => 19.5,
                            45 => 35.6,
                            46 => 50.5,
                            47 => 49.4,
                            48 => 26.5,
                            49 => 22,
                            50 => 35.5,
                            51 => 25.2,
                            52 => 72,
                            53 => 72,
                            54 => 72,
                            55 => 72,
                            56 => 72,
                            57 => 72,
                            58 => 72,
                            59 => 72,
                            60 => 72,
                            61 => 45,
                            62 => 55.5,
                            63 => 55.5,
                            64 => 72,
                            65 => 55.5,
                            66 => 55.5,
                            67 => 55.5,
                            68 => 55.5,
                            69 => 37,
                            70 => 72,
                            71 => 55.5,
                            72 => 37,
                            73 => 55.5,
                            74 => 72,
                            75 => 72,
                            76 => 72,
                            77 => 55.5,
                            78 => 72,
                            79 => 72,
                            80 => 72,
                            81 => 55.5,
                            82 => 72,
                        );
        
                    } elseif( $weight <= 2 ) {
    
                        $zonePrices =   array (
                            0 => 59.7,
                            1 => 57.8,
                            2 => 40.7,
                            3 => 47.8,
                            4 => 45.3,
                            5 => 43.2,
                            6 => 27.6,
                            7 => 63.8,
                            8 => 54.7,
                            9 => 62.5,
                            10 => 26.2,
                            11 => 30.3,
                            12 => 58.8,
                            13 => 56,
                            14 => 34.1,
                            15 => 33.9,
                            16 => 58.3,
                            17 => 37.6,
                            18 => 62.5,
                            19 => 58.6,
                            20 => 35.8,
                            21 => 58.3,
                            22 => 61.2,
                            23 => 34.5,
                            24 => 43.6,
                            25 => 30.3,
                            26 => 25.3,
                            27 => 32.5,
                            28 => 49.2,
                            29 => 32.5,
                            30 => 46,
                            31 => 36.7,
                            32 => 59.2,
                            33 => 60.5,
                            34 => 35,
                            35 => 34.9,
                            36 => 57,
                            37 => 29,
                            38 => 52,
                            39 => 55.4,
                            40 => 44.5,
                            41 => 34.5,
                            42 => 47.7,
                            43 => 40.7,
                            44 => 22.5,
                            45 => 43.3,
                            46 => 59,
                            47 => 58.2,
                            48 => 31.2,
                            49 => 25.8,
                            50 => 41.8,
                            51 => 29.5,
                            52 => 95,
                            53 => 95,
                            54 => 95,
                            55 => 95,
                            56 => 95,
                            57 => 95,
                            58 => 95,
                            59 => 95,
                            60 => 95,
                            61 => 56.7,
                            62 => 68.6,
                            63 => 68.6,
                            64 => 95,
                            65 => 68.6,
                            66 => 68.6,
                            67 => 68.6,
                            68 => 68.6,
                            69 => 42,
                            70 => 95,
                            71 => 68.6,
                            72 => 42,
                            73 => 68.6,
                            74 => 95,
                            75 => 95,
                            76 => 95,
                            77 => 68.6,
                            78 => 95,
                            79 => 95,
                            80 => 95,
                            81 => 68.6,
                            82 => 95,
                        );
        
                    } elseif( $weight <= 2.5 ) {
    
                        $zonePrices = array (
                            0 => 65.5,
                            1 => 64.9,
                            2 => 45.8,
                            3 => 53.1,
                            4 => 49.9,
                            5 => 47.4,
                            6 => 30.8,
                            7 => 69.4,
                            8 => 60.3,
                            9 => 69.5,
                            10 => 28.6,
                            11 => 33.4,
                            12 => 64.2,
                            13 => 61.2,
                            14 => 37.1,
                            15 => 37.4,
                            16 => 64,
                            17 => 42.1,
                            18 => 68.3,
                            19 => 64,
                            20 => 39.7,
                            21 => 63.8,
                            22 => 67.4,
                            23 => 38.2,
                            24 => 47.9,
                            25 => 33.4,
                            26 => 27.6,
                            27 => 35.9,
                            28 => 54,
                            29 => 35.9,
                            30 => 50.1,
                            31 => 41.1,
                            32 => 65.3,
                            33 => 65.9,
                            34 => 38.7,
                            35 => 38.3,
                            36 => 62.6,
                            37 => 31.9,
                            38 => 57.3,
                            39 => 61.4,
                            40 => 48.7,
                            41 => 38.2,
                            42 => 52.7,
                            43 => 45.2,
                            44 => 24.8,
                            45 => 48.2,
                            46 => 64.3,
                            47 => 63.7,
                            48 => 34.4,
                            49 => 28.6,
                            50 => 45.9,
                            51 => 32.4,
                            52 => 115.1,
                            53 => 115.1,
                            54 => 115.1,
                            55 => 115.1,
                            56 => 115.1,
                            57 => 115.1,
                            58 => 115.1,
                            59 => 115.1,
                            60 => 115.1,
                            61 => 66.1,
                            62 => 82.2,
                            63 => 82.2,
                            64 => 115.1,
                            65 => 82.2,
                            66 => 82.2,
                            67 => 82.2,
                            68 => 82.2,
                            69 => 49.7,
                            70 => 115.1,
                            71 => 82.2,
                            72 => 49.7,
                            73 => 82.2,
                            74 => 115.1,
                            75 => 115.1,
                            76 => 115.1,
                            77 => 82.2,
                            78 => 115.1,
                            79 => 115.1,
                            80 => 115.1,
                            81 => 82.2,
                            82 => 115.1,
                        );
        
                    } elseif( $weight <= 3 ) {
    
                        $zonePrices = array (
                            0 => 75.7,
                            1 => 77.5,
                            2 => 54.9,
                            3 => 62.6,
                            4 => 58.1,
                            5 => 54.9,
                            6 => 36.5,
                            7 => 79.4,
                            8 => 70.2,
                            9 => 81.9,
                            10 => 33.1,
                            11 => 38.9,
                            12 => 73.9,
                            13 => 70.5,
                            14 => 42.5,
                            15 => 43.8,
                            16 => 74.1,
                            17 => 50.1,
                            18 => 78.7,
                            19 => 73.6,
                            20 => 46.5,
                            21 => 73.6,
                            22 => 78.5,
                            23 => 44.7,
                            24 => 55.6,
                            25 => 38.9,
                            26 => 31.8,
                            27 => 41.9,
                            28 => 62.6,
                            29 => 41.9,
                            30 => 57.3,
                            31 => 48.9,
                            32 => 76.2,
                            33 => 75.6,
                            34 => 45.3,
                            35 => 44.3,
                            36 => 72.6,
                            37 => 37,
                            38 => 66.6,
                            39 => 72.1,
                            40 => 56.2,
                            41 => 44.7,
                            42 => 61.4,
                            43 => 53.3,
                            44 => 28.8,
                            45 => 56.9,
                            46 => 73.8,
                            47 => 73.5,
                            48 => 40.1,
                            49 => 33.4,
                            50 => 53.2,
                            51 => 37.7,
                            52 => 135.1,
                            53 => 135.1,
                            54 => 135.1,
                            55 => 135.1,
                            56 => 135.1,
                            57 => 135.1,
                            58 => 135.1,
                            59 => 135.1,
                            60 => 135.1,
                            61 => 75.4,
                            62 => 95.8,
                            63 => 95.8,
                            64 => 135.1,
                            65 => 95.8,
                            66 => 95.8,
                            67 => 95.8,
                            68 => 95.8,
                            69 => 57.3,
                            70 => 135.1,
                            71 => 95.8,
                            72 => 57.3,
                            73 => 95.8,
                            74 => 135.1,
                            75 => 135.1,
                            76 => 135.1,
                            77 => 95.8,
                            78 => 135.1,
                            79 => 135.1,
                            80 => 135.1,
                            81 => 95.8,
                            82 => 135.1,
                          );
        
                    } elseif( $weight <= 3.5 ) {
    
                        $zonePrices = array (
                            0 => 85.8,
                            1 => 90.2,
                            2 => 64,
                            3 => 72.1,
                            4 => 66.2,
                            5 => 62.4,
                            6 => 42.2,
                            7 => 89.4,
                            8 => 80.2,
                            9 => 94.4,
                            10 => 37.5,
                            11 => 44.3,
                            12 => 83.5,
                            13 => 79.7,
                            14 => 47.8,
                            15 => 50.1,
                            16 => 84.3,
                            17 => 58.2,
                            18 => 89,
                            19 => 83.3,
                            20 => 53.4,
                            21 => 83.4,
                            22 => 89.5,
                            23 => 51.2,
                            24 => 63.3,
                            25 => 44.3,
                            26 => 36,
                            27 => 48,
                            28 => 71.2,
                            29 => 48,
                            30 => 64.6,
                            31 => 56.7,
                            32 => 87,
                            33 => 85.3,
                            34 => 51.9,
                            35 => 50.4,
                            36 => 82.7,
                            37 => 42.2,
                            38 => 75.9,
                            39 => 82.8,
                            40 => 63.6,
                            41 => 51.2,
                            42 => 70.2,
                            43 => 61.3,
                            44 => 32.9,
                            45 => 65.6,
                            46 => 83.2,
                            47 => 83.3,
                            48 => 45.8,
                            49 => 38.3,
                            50 => 60.4,
                            51 => 42.9,
                            52 => 155.2,
                            53 => 155.2,
                            54 => 155.2,
                            55 => 155.2,
                            56 => 155.2,
                            57 => 155.2,
                            58 => 155.2,
                            59 => 155.2,
                            60 => 155.2,
                            61 => 84.8,
                            62 => 109.4,
                            63 => 109.4,
                            64 => 155.2,
                            65 => 109.4,
                            66 => 109.4,
                            67 => 109.4,
                            68 => 109.4,
                            69 => 65,
                            70 => 155.2,
                            71 => 109.4,
                            72 => 65,
                            73 => 109.4,
                            74 => 155.2,
                            75 => 155.2,
                            76 => 155.2,
                            77 => 109.4,
                            78 => 155.2,
                            79 => 155.2,
                            80 => 155.2,
                            81 => 109.4,
                            82 => 155.2,
                          );
        
                    } elseif( $weight <= 4 ) {
    
                        $zonePrices = array (
                            0 => 96,
                            1 => 102.9,
                            2 => 73.1,
                            3 => 81.6,
                            4 => 74.4,
                            5 => 69.9,
                            6 => 47.8,
                            7 => 99.4,
                            8 => 90.2,
                            9 => 106.8,
                            10 => 41.9,
                            11 => 49.8,
                            12 => 93.2,
                            13 => 89,
                            14 => 53.2,
                            15 => 56.5,
                            16 => 94.4,
                            17 => 66.2,
                            18 => 99.4,
                            19 => 92.9,
                            20 => 60.2,
                            21 => 93.2,
                            22 => 100.6,
                            23 => 57.7,
                            24 => 71,
                            25 => 49.8,
                            26 => 40.2,
                            27 => 54,
                            28 => 79.8,
                            29 => 54,
                            30 => 71.9,
                            31 => 64.6,
                            32 => 97.9,
                            33 => 95,
                            34 => 58.5,
                            35 => 56.5,
                            36 => 92.7,
                            37 => 47.3,
                            38 => 85.2,
                            39 => 93.5,
                            40 => 71.1,
                            41 => 57.7,
                            42 => 78.9,
                            43 => 69.4,
                            44 => 36.9,
                            45 => 74.3,
                            46 => 92.7,
                            47 => 93.1,
                            48 => 51.5,
                            49 => 43.1,
                            50 => 67.7,
                            51 => 48.1,
                            52 => 175.3,
                            53 => 175.3,
                            54 => 175.3,
                            55 => 175.3,
                            56 => 175.3,
                            57 => 175.3,
                            58 => 175.3,
                            59 => 175.3,
                            60 => 175.3,
                            61 => 94.1,
                            62 => 123,
                            63 => 123,
                            64 => 175.3,
                            65 => 123,
                            66 => 123,
                            67 => 123,
                            68 => 123,
                            69 => 72.6,
                            70 => 175.3,
                            71 => 123,
                            72 => 72.6,
                            73 => 123,
                            74 => 175.3,
                            75 => 175.3,
                            76 => 175.3,
                            77 => 123,
                            78 => 175.3,
                            79 => 175.3,
                            80 => 175.3,
                            81 => 123,
                            82 => 175.3,
                          );
        
                    } elseif( $weight <= 4.5 ) {
    
                        $zonePrices = array (
                            0 => 106.2,
                            1 => 115.6,
                            2 => 82.2,
                            3 => 91.1,
                            4 => 82.5,
                            5 => 77.4,
                            6 => 53.5,
                            7 => 109.3,
                            8 => 100.2,
                            9 => 119.3,
                            10 => 46.3,
                            11 => 55.3,
                            12 => 102.8,
                            13 => 98.2,
                            14 => 58.5,
                            15 => 62.8,
                            16 => 104.5,
                            17 => 74.3,
                            18 => 109.7,
                            19 => 102.6,
                            20 => 67,
                            21 => 103,
                            22 => 111.7,
                            23 => 64.2,
                            24 => 78.8,
                            25 => 55.3,
                            26 => 44.4,
                            27 => 60,
                            28 => 88.4,
                            29 => 60,
                            30 => 79.2,
                            31 => 72.4,
                            32 => 108.7,
                            33 => 104.7,
                            34 => 65.2,
                            35 => 62.5,
                            36 => 102.7,
                            37 => 52.4,
                            38 => 94.5,
                            39 => 104.2,
                            40 => 78.5,
                            41 => 64.2,
                            42 => 87.7,
                            43 => 77.4,
                            44 => 40.9,
                            45 => 83.1,
                            46 => 102.2,
                            47 => 102.9,
                            48 => 57.1,
                            49 => 48,
                            50 => 75,
                            51 => 53.4,
                            52 => 195.3,
                            53 => 195.3,
                            54 => 195.3,
                            55 => 195.3,
                            56 => 195.3,
                            57 => 195.3,
                            58 => 195.3,
                            59 => 195.3,
                            60 => 195.3,
                            61 => 103.5,
                            62 => 136.6,
                            63 => 136.6,
                            64 => 195.3,
                            65 => 136.6,
                            66 => 136.6,
                            67 => 136.6,
                            68 => 136.6,
                            69 => 80.3,
                            70 => 195.3,
                            71 => 136.6,
                            72 => 80.3,
                            73 => 136.6,
                            74 => 195.3,
                            75 => 195.3,
                            76 => 195.3,
                            77 => 136.6,
                            78 => 195.3,
                            79 => 195.3,
                            80 => 195.3,
                            81 => 136.6,
                            82 => 195.3,
                          );
        
                    } elseif( $weight <= 5 ) {
    
                        $zonePrices = array (
                            0 => 116.4,
                            1 => 126.7,
                            2 => 91.3,
                            3 => 100.5,
                            4 => 90.7,
                            5 => 84.9,
                            6 => 59.2,
                            7 => 119.3,
                            8 => 110.1,
                            9 => 131.7,
                            10 => 50.7,
                            11 => 60.7,
                            12 => 112.4,
                            13 => 107.5,
                            14 => 63.9,
                            15 => 69.1,
                            16 => 114.7,
                            17 => 82.3,
                            18 => 120.1,
                            19 => 112.2,
                            20 => 73.9,
                            21 => 112.8,
                            22 => 122.8,
                            23 => 70.7,
                            24 => 86.5,
                            25 => 60.7,
                            26 => 48.6,
                            27 => 66,
                            28 => 97,
                            29 => 66,
                            30 => 86.5,
                            31 => 80.2,
                            32 => 119.6,
                            33 => 114.4,
                            34 => 71.8,
                            35 => 68.6,
                            36 => 112.8,
                            37 => 57.6,
                            38 => 103.8,
                            39 => 114.9,
                            40 => 85.9,
                            41 => 70.7,
                            42 => 96.5,
                            43 => 85.5,
                            44 => 45,
                            45 => 91.8,
                            46 => 111.7,
                            47 => 112.7,
                            48 => 62.8,
                            49 => 52.8,
                            50 => 82.3,
                            51 => 58.6,
                            52 => 215.4,
                            53 => 215.4,
                            54 => 215.4,
                            55 => 215.4,
                            56 => 215.4,
                            57 => 215.4,
                            58 => 215.4,
                            59 => 215.4,
                            60 => 215.4,
                            61 => 112.8,
                            62 => 150.2,
                            63 => 150.2,
                            64 => 215.4,
                            65 => 150.2,
                            66 => 150.2,
                            67 => 150.2,
                            68 => 150.2,
                            69 => 87.9,
                            70 => 215.4,
                            71 => 150.2,
                            72 => 87.9,
                            73 => 150.2,
                            74 => 215.4,
                            75 => 215.4,
                            76 => 215.4,
                            77 => 150.2,
                            78 => 215.4,
                            79 => 215.4,
                            80 => 215.4,
                            81 => 150.2,
                            82 => 215.4,
                          );
        
                    }
    
                    $zoneFromCountry = $countryZones[ $country ];
                    $priceFromZone = $zonePrices[ $zoneFromCountry ];

                    $TutsPlus_Shipping_Method = new TutsPlus_Shipping_Method();
                    $tax = (int) $TutsPlus_Shipping_Method->settings['insurance'];

                    $cost =  (($tax / 100) * $priceFromZone) + $priceFromZone; 
  
                    $rate = array(
                        'id' => $this->id,
                        'label' => $this->title,
                        'cost' => number_format( round($cost, 1), 1 )
                    ); 
  
                    $this->add_rate( $rate );
                     
                }
            }
        }
    }
 
    add_action( 'woocommerce_shipping_init', 'tutsplus_shipping_method' );
 
    function add_tutsplus_shipping_method( $methods ) {
        $methods[] = 'TutsPlus_Shipping_Method';
        return $methods;
    }
 
    add_filter( 'woocommerce_shipping_methods', 'add_tutsplus_shipping_method' );
 
    function tutsplus_validate_order( $posted )   {
 
        $packages = WC()->shipping->get_packages();
 
        $chosen_methods = WC()->session->get( 'chosen_shipping_methods' );
         
        if( is_array( $chosen_methods ) && in_array( 'tutsplus', $chosen_methods ) ) {
             
            foreach ( $packages as $i => $package ) { 
 
                if ( $chosen_methods[ $i ] != "tutsplus" ) {
                             
                    continue;
                             
                }
 
                $TutsPlus_Shipping_Method = new TutsPlus_Shipping_Method();
                $weightLimit = (int) $TutsPlus_Shipping_Method->settings['weight'];
                $weight = 0;
                
                foreach ( $package['contents'] as $item_id => $values ) 
                { 
                    $_product = $values['data']; 
                    $weight = $weight + $_product->get_weight() * $values['quantity']; 
                }
                $weight = wc_get_weight( $weight, 'gr' );    
                if( $weight > $weightLimit ) {
 
                        $message = sprintf( __( 'Sorry, %d kg exceeds the maximum weight of %d kg for %s', 'tutsplus' ), $weight, $weightLimit, $TutsPlus_Shipping_Method->title );
                             
                        $messageType = "error";
 
                        if( ! wc_has_notice( $message, $messageType ) ) {
                         
                            wc_add_notice( $message, $messageType );
                      
                        }
                }
            }       
        } 
    }
 
    add_action( 'woocommerce_review_order_before_cart_contents', 'tutsplus_validate_order' , 10 );
    add_action( 'woocommerce_after_checkout_validation', 'tutsplus_validate_order' , 10 );
}
